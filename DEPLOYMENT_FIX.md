# Исправление проблемы с 403 ошибкой в продакшене

## Проблема
После логина пользователь получает 403 Forbidden ошибку при попытке доступа к `/api/auth/eventums/` и перенаправляется обратно на страницу входа.

## Внесенные исправления

### 1. Исправление настроек DEBUG
- Изменили `DEBUG = True` на `DEBUG = os.getenv('DEBUG', 'False').lower() in ('true', '1', 'yes')`
- Теперь DEBUG контролируется переменной окружения

### 2. Исправление CORS заголовков
- Добавили `'Authorization'` (с заглавной буквы) в `CORS_ALLOWED_HEADERS`
- Оставили и `'authorization'` (строчными) для совместимости

### 3. Добавление middleware для отладки
- Создали `AuthDebugMiddleware` для логирования запросов и ошибок аутентификации
- Добавили настройки логирования в `settings.py`

### 4. Улучшение обработки ошибок на фронтенде
- Добавили подробное логирование ошибок API
- Улучшили процесс обновления токенов

### 5. Улучшение логирования в API
- Добавили детальное логирование в `user_eventums` view

### 6. Улучшение VK аутентификации
- Добавили подробное логирование в VK аутентификацию
- Создали endpoint `/api/auth/vk-config/` для проверки настроек VK

### 7. Улучшение отладки токенов
- Добавили подробное логирование в процесс сохранения и передачи токенов
- Добавили логирование в API клиент для отслеживания заголовков авторизации
- Добавили отладочную информацию в DashboardPage

### 8. Улучшение отладки JWT аутентификации
- Добавили детальное логирование JWT токенов в middleware
- Добавили отладочный endpoint `/api/auth/debug-user/` для проверки аутентификации
- Улучшили логирование в `user_eventums` view

### 9. Улучшение отладки CORS
- Добавили логирование всех заголовков в middleware
- Добавили специальную обработку для CORS preflight запросов
- Включили `CORS_ALLOW_ALL_HEADERS = True` для отладки

### 10. Исправление CORS для заголовка Authorization
- Исправили порядок заголовков в `CORS_ALLOWED_HEADERS` (authorization должен быть первым)
- Добавили `CORS_EXPOSE_HEADERS` для заголовка Authorization
- Добавили проверку preflight запросов в middleware

### 11. Радикальное исправление CORS
- Создали кастомный `CORSFixMiddleware` для ручной обработки CORS
- Временно отключили стандартный `corsheaders.middleware.CorsMiddleware`
- Добавили детальное логирование preflight запросов

### 12. Исправление JWT аутентификации
- Добавили ручную аутентификацию пользователя в middleware
- Теперь заголовок Authorization доходит до бэкенда
- Добавили проверку и валидацию JWT токенов

### 13. Радикальное исправление CORS и CSRF
- Разрешили ВСЕ заголовки в CORS (`Access-Control-Allow-Headers: *`)
- Временно отключили CSRF защиту для отладки
- Добавили детальное логирование всех заголовков

### 14. Исправление CORS preflight запросов
- Добавили специальную обработку для OPTIONS запросов
- Добавили детальное логирование preflight запросов
- Исправили статус код для preflight ответов (200 вместо 204)

### 15. Диагностика JWT аутентификации
- Выяснили, что curl к localhost работает, но к серверу не работает
- Заголовок Authorization доходит до сервера, но JWT аутентификация не работает
- Добавили ручную аутентификацию пользователя в middleware
- Проблема в том, что JWT middleware не работает в продакшене

### 16. Исправление для Yandex Cloud Serverless
- Добавили отладку SECRET_KEY и JWT настроек
- Переместили AuthDebugMiddleware ПЕРЕД AuthenticationMiddleware
- Добавили детальное логирование JWT ошибок
- Проверяем переменные окружения в serverless

### 17. Альтернативные способы передачи токена
- Добавили поддержку передачи токена через query параметры (`?access_token=...`)
- Добавили поддержку передачи токена через POST данные
- Обновили фронтенд для отправки токена разными способами
- Добавили тестовый endpoint `/api/auth/test-token/` для проверки

## Развертывание

### 1. Обновите переменные окружения в продакшене
Добавьте в `.env` файл продакшена:
```env
DEBUG=False
```

### 2. Перезапустите бэкенд
```bash
# В контейнере Yandex Cloud
docker-compose restart backend
# или
docker restart <container_name>
```

### 3. Проверьте логи
После развертывания проверьте логи для диагностики:
```bash
# Логи приложения
docker logs <container_name>

# Логи аутентификации (если файл создался)
cat auth_debug.log
```

## Диагностика

### Проверка CORS
Убедитесь, что фронтенд отправляет правильные заголовки:
```javascript
// В консоли браузера
fetch('https://bbapo5ibqs4eg6dail89.containers.yandexcloud.net/api/auth/eventums/', {
  headers: {
    'Authorization': 'Bearer YOUR_TOKEN_HERE'
  }
})
```

### Проверка токенов
1. Проверьте, что токены сохраняются в localStorage
2. Проверьте, что токены не истекли
3. Проверьте, что токены передаются в заголовке Authorization

### Проверка пользователя в базе
Убедитесь, что пользователь существует и имеет роли:
```python
# В Django shell
from app.models import UserProfile, UserRole
user = UserProfile.objects.get(vk_id=YOUR_VK_ID)
roles = UserRole.objects.filter(user=user)
print(f"User: {user.name}, Roles: {[r.role for r in roles]}")
```

### Проверка настроек VK
Проверьте настройки VK в продакшене:
```bash
curl https://bbapo5ibqs4eg6dail89.containers.yandexcloud.net/api/auth/vk-config/
```

Должно вернуть:
```json
{
  "VK_APP_ID": "your_app_id",
  "VK_REDIRECT_URI": "https://eventum-web-ui.vercel.app",
  "DEBUG": false,
  "ALLOWED_HOSTS": ["*"]
}
```

## Возможные дополнительные проблемы

1. **Проблемы с VK аутентификацией в продакшене** - проверьте настройки VK приложения
2. **Проблемы с базой данных** - убедитесь, что пользователь и роли созданы правильно
3. **Проблемы с сетью** - проверьте, что запросы доходят до бэкенда

## Мониторинг

После развертывания следите за логами:
- Ошибки аутентификации в консоли браузера
- Логи middleware в бэкенде
- Статус коды ответов API
