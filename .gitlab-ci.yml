stages:
  - build
  - release

# Сборка образа контейнера.
build-job:
  stage: build
# Использование kaniko для создания контейнера внутри контейнера для большей безопасности.
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
# Отправка образа контейнера в реестр. Образ отмечен хэшем коммита.
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(echo -n "json_key:${CI_REGISTRY_KEY}" | base64 | tr -d '\n' )\"}}}" > /kaniko/.docker/config.json
    - >-
      /kaniko/executor
      --context "${CI_PROJECT_DIR}/backend"
      --dockerfile "${CI_PROJECT_DIR}/backend/Dockerfile"
      --destination "${CI_REGISTRY}/${CI_PROJECT_PATH}:${CI_COMMIT_SHORT_SHA}"

release-job:
  stage: release
  image: alpine:3.15
  script:
    - apk add -q --no-cache bash curl jq gettext
    - curl --fail --silent --location --remote-name https://storage.yandexcloud.net/yandexcloud-yc/install.sh
    - bash install.sh -i /usr/local/yandex-cloud -n
    - ln -s /usr/local/yandex-cloud/bin/yc /usr/local/bin/yc
    - echo "$SA_PROD_DEPLOYER_PRIVATE_KEY" > key.json
    - yc config profile create sa-profile
    - yc config set service-account-key key.json
    - yc serverless container revision deploy
      --container-id ${CI_CONTAINER_ID_prod}
      --image "${CI_REGISTRY}/${CI_PROJECT_PATH}:${CI_COMMIT_SHORT_SHA}"
      --cores 4
      --memory 1024mb
      --concurrency 1
      --execution-timeout 10s
      --cloud-id ${cloud_id}
      --folder-id ${cart_prod}
      --service-account-id ${PROD_SA_ID}
      --secret environment-variable=DB_NAME,id=e6qmac6cr2goqb03sfjn,version-id=e6qtom5dst8bamfc4pfh,key=DB_NAME
      --secret environment-variable=DB_HOST,id=e6qmac6cr2goqb03sfjn,version-id=e6qtom5dst8bamfc4pfh,key=DB_HOST
      --secret environment-variable=DB_PASSWORD,id=e6qmac6cr2goqb03sfjn,version-id=e6qtom5dst8bamfc4pfh,key=DB_PASSWORD
      --secret environment-variable=DB_USER,id=e6qmac6cr2goqb03sfjn,version-id=e6qtom5dst8bamfc4pfh,key=DB_USER
      --secret environment-variable=DJANGO_SECRET_KEY,id=e6q6ecgut30u34e250gm,version-id=e6qvonsc1vrqc4noahcg,key=DJANGO_SECRET_KEY
      --secret environment-variable=VK_APP_ID,id=e6q6ecgut30u34e250gm,version-id=e6qvonsc1vrqc4noahcg,key=VK_APP_ID
      --secret environment-variable=VK_APP_SECRET,id=e6q6ecgut30u34e250gm,version-id=e6qvonsc1vrqc4noahcg,key=VK_APP_SECRET
      --secret environment-variable=VK_REDIRECT_URI,id=e6q6ecgut30u34e250gm,version-id=e6qvonsc1vrqc4noahcg,key=VK_REDIRECT_URI 
    - container_id=${prod_container_id}
# Создание продакшн среды.
  environment:
    name: production/$CI_COMMIT_SHORT_SHA
